---
layout: post
title: "[MS Access] フォームを開くときに特定のリボンタブをアクティブ化する"
date: '2013-11-20T16:53:00.000+09:00'
author: Kenji Sato
tags:
- Access
modified_time: '2013-11-20T22:24:25.122+09:00'
thumbnail: http://1.bp.blogspot.com/-SAi-4O6J3RQ/UoxXsY36tNI/AAAAAAAAVTY/dVmgf6KqXww/s72-c/Screen+Shot+2013-11-20+at+3.32.47+p.png
blogger_id: tag:blogger.com,1999:blog-4561499355301538052.post-2119449439308892205
blogger_orig_url: http://www.kenjisato.jp/2013/11/ms-access.html
---

<p>Microsoft Accessのフォームに特定のリボン（カスタムリボン）をアクティブ化するコードを書いていて，</p><ol><li>Accessファイルを開いた直後にそのフォームを開くとアクティブ化しない</li><li>当該フォームを一度閉じて再度開くとアクティブ化する</li></ol><p>という現象に遭遇しました．結論から先に書くと，<code>customUI</code>要素の<em><b><code>onLoad</code>プロパティに指定したコールバック関数は，フォームを開くときに起こる一連のイベント（Open→Load→Resize→Activate→Current）がすべて終わったあとに実行される</b></em>ようでして, <code>Open</code>イベント時に <code>DoCmd.SelectObject</code> を実行して，これから開こうとするフォームを強制的に選択するということで解決しました．これについて書かれている記事を見つけることができなかったので，一応記録しておきます．</p> <p>テスト用のリボンXMLはこれを使います (<a href="https://github.com/kenjisato/access/blob/master/rbn1/ribbon.xml">github</a>)</p><script type='syntaxhighlighter' class='brush: xml' title='USysRibbons / RibbonName=Ribbon1'><![CDATA[ <customUI xmlns="http://schemas.microsoft.com/office/2009/07/customui" onLoad="OnRibbonLoad">  <ribbon startFromScratch="false">    <tabs>      <tab id="rbn1_tab1" label="サンプルタブ" visible="true">        <group id="rbn1_tab1_grp1" label="サンプルグループ">          <checkBox id="rbn1_tab1_grp1_cbx1" label="チェックボックス" />        </group>      </tab>    </tabs>  </ribbon></customUI>]]></script> <p>フォーム <code>frmSample</code> を作って，リボン名を <code>Ribbon1</code> にします．中身はなんでもいいですが，テスト用の出力を表示するテキストボックスコントロールだけ作っておきました．</p><p><a href="http://1.bp.blogspot.com/-SAi-4O6J3RQ/UoxXsY36tNI/AAAAAAAAVTY/dVmgf6KqXww/s1600/Screen+Shot+2013-11-20+at+3.32.47+p.png" imageanchor="1" ><img border="0" src="http://1.bp.blogspot.com/-SAi-4O6J3RQ/UoxXsY36tNI/AAAAAAAAVTY/dVmgf6KqXww/s320/Screen+Shot+2013-11-20+at+3.32.47+p.png" /></a></p> <p>コールバック関数などもろもろのリボン用の標準モジュールは次のようにします (<a href="https://github.com/kenjisato/access/blob/master/rbn1/modRibbons.txt">github</a>)．あわせて，<code>Microsoft Office 15.0 Object Library</code>を参照するように設定します．</p> <script type='syntaxhighlighter' class='brush: vb' title='modRibbons'><![CDATA[ Option Compare Database Option Explicit  Public glbRibbon As IRibbonUI  Public Sub OnRibbonLoad(ribbon As IRibbonUI)   Set glbRibbon = ribbon End Sub ]]></script>  <p>どの時点で onLoadのコールバックが実行されるかが分かりやすいように，<code>glbResult</code>変数に<code>glbRibbon</code>がセットされているかを記録していき，最後にフォームのコントロールに出力します．<code>frmSample</code>のフォームモジュールは次のようにします (<a href="https://github.com/kenjisato/access/blob/master/rbn1/Form_frmSample.txt">github</a>)．</p> <script type='syntaxhighlighter' class='brush: vb' title='Form_frmSample'><![CDATA[ Option Compare Database Option Explicit  Private glbResult As String  Private Sub Form_Open(Cancel As Integer)      glbResult = "On Open, Before Select : " & vbCrLf & IsNothing          DoCmd.SelectObject acForm, Me.Name          glbResult = glbResult & "On Open, After Select : " & vbCrLf & IsNothing End Sub  Private Sub Form_Load()      glbResult = glbResult & "On Load : " & vbCrLf & IsNothing                      If Not (glbRibbon Is Nothing) Then         glbRibbon.ActivateTab "rbn1_tab1"     End If End Sub  Private Sub Form_Resize()     glbResult = glbResult & "On Resize :" & vbCrLf & IsNothing End Sub  Private Sub Form_Activate()     glbResult = glbResult & "On Active : " & vbCrLf & IsNothing End Sub  Private Sub Form_Current()     glbResult = glbResult & "On Current : " & vbCrLf & IsNothing     Me.txtResult = glbResult End Sub  Private Function IsNothing() As String     IsNothing = IIf(glbRibbon Is Nothing, "    Nothing", "    Not Nothing") & vbCrLf End Function ]]></script> <p>フォームを開くと次のような結果となりました．「サンプルタブ」がアクティブ化されています．</p><p><a href="http://1.bp.blogspot.com/-nnyuOJfoxdA/UoxjDX698_I/AAAAAAAAVT0/ccQBV9K2wCo/s1600/Screen+Shot+2013-11-20+at+4.21.38+p.png" imageanchor="1" ><img border="0" src="http://1.bp.blogspot.com/-nnyuOJfoxdA/UoxjDX698_I/AAAAAAAAVT0/ccQBV9K2wCo/s320/Screen+Shot+2013-11-20+at+4.21.38+p.png" /></a></p> <p>出力を見る限り，<code>SelectObject</code>コマンドの影響で<code>Form_Open</code>プロシージャの実行途中に<code>Current</code>以外のイベントが割り込んでいますが，いずれにおいても<code>glbRibbon</code>にはリボンUIオブジェクトがセットされた状態になっていますので，タブのアクティブ化のコードを実行するタイミングは，<code>DoCmd.SelectObject</code>の後ならどこでもよいことが分かります．</p> <p>サンプルファイル → <a href="https://github.com/kenjisato/access/blob/master/rbn1/rbn1.zip">rbn1.zip (35KB)</a> <p>解決に際しては，フォームオープン時の振舞いをカスタマイズする方法についての記事『<a href="http://www.tsware.jp/study/vol5/event_01.htm">T'sWare Access Study Vol.5 イベント徹底活用#1 フォームのオープン・クローズのイベント</a>』が非常に参考になりましたので，付け加えさせていただきます．</p>  <iframe src="http://rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=FFFFFF&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=tantebellecos-22&o=9&p=8&l=as4&m=amazon&f=ifr&ref=ss_til&asins=1118490355" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe> <iframe src="http://rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=FFFFFF&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=tantebellecos-22&o=9&p=8&l=as4&m=amazon&f=ifr&ref=ss_til&asins=B00CBK0UN4" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>